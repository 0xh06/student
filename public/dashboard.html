<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NexusEDU ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --void:#030508;--deep:#080d18;--surface:#0d1425;
  --panel:rgba(13,20,37,0.85);--panel2:rgba(8,13,24,0.9);
  --border:rgba(0,212,255,0.12);--border2:rgba(255,255,255,0.06);
  --glow:#00d4ff;--glow2:#7b61ff;--green:#00ffaa;--amber:#ffb547;--danger:#ff4b6e;
  --text:#e8f4ff;--muted:rgba(232,244,255,0.5);--dim:rgba(232,244,255,0.22);
  --sidebar:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--void);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden;}

body::before{
  content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);
  background-size:50px 50px;pointer-events:none;
}
.orb{position:fixed;border-radius:50%;filter:blur(100px);opacity:0.15;pointer-events:none;}
.orb-1{width:600px;height:600px;background:var(--glow2);top:-200px;right:-100px;}
.orb-2{width:500px;height:500px;background:var(--glow);bottom:-200px;left:100px;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{
  position:fixed;top:0;left:0;width:var(--sidebar);height:100vh;
  background:var(--panel2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;padding:28px 20px;z-index:100;
  backdrop-filter:blur(20px);
}
.sidebar-logo{display:flex;align-items:center;gap:12px;margin-bottom:36px;padding:0 8px;}
.logo-icon{
  width:42px;height:42px;
  background:linear-gradient(135deg,var(--glow2),var(--glow));
  border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
  box-shadow:0 0 20px rgba(0,212,255,0.3);
}
.logo-text{font-weight:900;font-size:18px;letter-spacing:3px;background:linear-gradient(135deg,#fff,var(--glow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.nav-section{margin-bottom:8px;}
.nav-label{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--dim);padding:0 12px;margin-bottom:8px;font-family:'Space Mono',monospace;}

.nav-item{
  display:flex;align-items:center;gap:12px;padding:12px 14px;
  border-radius:12px;cursor:pointer;transition:all 0.25s;
  color:var(--muted);font-size:13.5px;font-weight:600;
  border:1px solid transparent;margin-bottom:4px;user-select:none;
  text-decoration:none;
}
.nav-item:hover{background:rgba(255,255,255,0.05);color:var(--text);border-color:var(--border);}
.nav-item.active{background:rgba(0,212,255,0.08);color:var(--glow);border-color:rgba(0,212,255,0.2);}
.nav-item .icon{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.nav-item.active .icon{background:rgba(0,212,255,0.15);}
.nav-badge{margin-left:auto;background:var(--danger);color:white;border-radius:20px;padding:2px 8px;font-size:10px;font-weight:700;}

/* ADMIN TOGGLE */
.admin-toggle-wrap{margin-top:auto;padding-top:20px;border-top:1px solid var(--border2);}
.view-toggle{
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border2);
  border-radius:14px;padding:6px;
  display:flex;gap:4px;margin-bottom:16px;
}
.toggle-btn{
  flex:1;padding:9px 6px;border:none;border-radius:10px;
  font-family:'Outfit',sans-serif;font-weight:700;font-size:12px;
  cursor:pointer;transition:all 0.3s;color:var(--muted);background:transparent;
  letter-spacing:0.5px;
}
.toggle-btn.active{
  background:linear-gradient(135deg,var(--glow2),var(--glow));
  color:white;box-shadow:0 4px 15px rgba(0,212,255,0.25);
}

/* SIDEBAR PROFILE */
.sidebar-profile{display:flex;align-items:center;gap:10px;padding:12px 8px;}
.s-avatar{width:38px;height:38px;border-radius:50%;border:2px solid var(--glow);background:linear-gradient(135deg,var(--glow2),var(--glow));display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;overflow:hidden;}
.s-avatar img{width:100%;height:100%;object-fit:cover;}
.s-info{flex:1;min-width:0;}
.s-name{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.s-role{font-size:11px;color:var(--glow);letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;}

.logout-btn{
  width:100%;padding:11px;border:1px solid rgba(255,75,110,0.2);
  background:rgba(255,75,110,0.06);border-radius:10px;
  color:#ff7a95;font-family:'Outfit',sans-serif;font-weight:700;font-size:13px;
  cursor:pointer;transition:all 0.3s;margin-top:10px;
}
.logout-btn:hover{background:rgba(255,75,110,0.15);border-color:rgba(255,75,110,0.4);}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
.main{margin-left:var(--sidebar);padding:32px 36px;min-height:100vh;position:relative;z-index:1;}

/* PAGE HEADER */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;}
.page-title{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:4px;}
.page-name{font-weight:900;font-size:28px;background:linear-gradient(135deg,#fff 40%,var(--glow));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.header-right{display:flex;align-items:center;gap:12px;}
.notif-btn{
  width:40px;height:40px;border-radius:12px;
  background:rgba(255,255,255,0.05);border:1px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;transition:all 0.3s;position:relative;
}
.notif-dot{position:absolute;top:8px;right:8px;width:7px;height:7px;background:var(--danger);border-radius:50%;border:1.5px solid var(--void);}

/* PAGES */
.page{display:none;animation:fadeIn 0.4s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* CARDS */
.card{
  background:var(--panel);border:1px solid var(--border2);
  border-radius:20px;backdrop-filter:blur(20px);
  box-shadow:0 4px 30px rgba(0,0,0,0.3);overflow:hidden;
}
.card-header{
  padding:22px 24px 18px;border-bottom:1px solid var(--border2);
  display:flex;align-items:center;justify-content:space-between;
}
.card-title{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px;}
.card-body{padding:24px;}

/* PROFILE HERO */
.profile-hero{
  background:linear-gradient(135deg,rgba(123,97,255,0.15),rgba(0,212,255,0.1));
  border:1px solid var(--border);border-radius:22px;padding:28px 32px;
  margin-bottom:24px;display:flex;align-items:center;gap:28px;position:relative;overflow:hidden;
}
.profile-hero::before{
  content:'';position:absolute;top:-50%;right:-50px;
  width:300px;height:300px;border-radius:50%;
  background:radial-gradient(circle,rgba(0,212,255,0.08),transparent 70%);
}
.hero-avatar{
  width:90px;height:90px;border-radius:22px;
  border:2px solid var(--glow);
  background:linear-gradient(135deg,var(--glow2),var(--glow));
  display:flex;align-items:center;justify-content:center;
  font-size:38px;flex-shrink:0;overflow:hidden;
  box-shadow:0 0 30px rgba(0,212,255,0.25);
}
.hero-avatar img{width:100%;height:100%;object-fit:cover;}
.hero-info{flex:1;}
.hero-name{font-weight:900;font-size:26px;margin-bottom:4px;}
.hero-email{color:var(--muted);font-size:14px;margin-bottom:12px;}
.hero-tags{display:flex;gap:8px;flex-wrap:wrap;}
.tag{
  padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  font-family:'Space Mono',monospace;
}
.tag-blue{background:rgba(0,212,255,0.12);color:var(--glow);border:1px solid rgba(0,212,255,0.25);}
.tag-purple{background:rgba(123,97,255,0.12);color:#a78bff;border:1px solid rgba(123,97,255,0.25);}
.tag-green{background:rgba(0,255,170,0.1);color:var(--green);border:1px solid rgba(0,255,170,0.2);}
.tag-amber{background:rgba(255,181,71,0.1);color:var(--amber);border:1px solid rgba(255,181,71,0.2);}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}

/* STAT CARDS */
.stat-card{
  background:var(--panel);border:1px solid var(--border2);border-radius:18px;
  padding:20px 22px;position:relative;overflow:hidden;transition:all 0.3s;
}
.stat-card:hover{border-color:var(--border);transform:translateY(-2px);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card.blue::before{background:linear-gradient(90deg,var(--glow2),var(--glow));}
.stat-card.green::before{background:linear-gradient(90deg,var(--green),#00d4aa);}
.stat-card.amber::before{background:linear-gradient(90deg,var(--amber),#ff8a00);}
.stat-card.red::before{background:linear-gradient(90deg,var(--danger),#ff8a6e);}
.stat-icon{font-size:22px;margin-bottom:12px;}
.stat-val{font-weight:900;font-size:28px;font-family:'Space Mono',monospace;margin-bottom:4px;}
.stat-label{font-size:12px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}

/* FORM STYLES */
.form-section{margin-bottom:28px;}
.form-section-title{
  font-size:11px;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:8px;
  font-family:'Space Mono',monospace;
}
.form-section-title::after{content:'';flex:1;height:1px;background:var(--border2);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.field{display:flex;flex-direction:column;gap:8px;}
.field.full{grid-column:1/-1;}
.field label{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;}
.field input,.field select,.field textarea{
  background:rgba(255,255,255,0.04);border:1px solid var(--border2);
  border-radius:12px;padding:12px 14px;color:var(--text);
  font-family:'Outfit',sans-serif;font-size:14px;outline:none;transition:all 0.3s;
}
.field input:focus,.field select:focus,.field textarea:focus{
  border-color:var(--glow);background:rgba(0,212,255,0.04);
  box-shadow:0 0 0 3px rgba(0,212,255,0.08);
}
.field input::placeholder{color:var(--dim);}
.field select option{background:var(--surface);}
.field textarea{resize:vertical;min-height:80px;}

/* PHOTO UPLOAD */
.photo-upload-wrap{display:flex;align-items:center;gap:20px;margin-bottom:24px;}
.photo-preview{
  width:80px;height:80px;border-radius:18px;
  border:2px dashed rgba(0,212,255,0.3);
  background:rgba(0,212,255,0.05);
  display:flex;align-items:center;justify-content:center;
  font-size:30px;cursor:pointer;overflow:hidden;transition:all 0.3s;
}
.photo-preview:hover{border-color:var(--glow);background:rgba(0,212,255,0.1);}
.photo-preview img{width:100%;height:100%;object-fit:cover;}
.photo-info p{font-size:13px;color:var(--muted);margin-top:4px;}
input[type="file"]{display:none;}
.upload-btn{
  padding:9px 18px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.25);
  border-radius:10px;color:var(--glow);font-family:'Outfit',sans-serif;
  font-weight:700;font-size:13px;cursor:pointer;transition:all 0.3s;
}
.upload-btn:hover{background:rgba(0,212,255,0.18);}

/* BUTTONS */
.btn{padding:13px 24px;border:none;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:700;font-size:14px;cursor:pointer;transition:all 0.3s;}
.btn-primary{background:linear-gradient(135deg,var(--glow2),var(--glow));color:white;box-shadow:0 6px 20px rgba(0,212,255,0.2);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,212,255,0.35);}
.btn-secondary{background:rgba(255,255,255,0.06);border:1px solid var(--border2);color:var(--muted);}
.btn-secondary:hover{background:rgba(255,255,255,0.1);color:var(--text);}
.btn-danger{background:rgba(255,75,110,0.1);border:1px solid rgba(255,75,110,0.25);color:#ff7a95;}
.btn-danger:hover{background:rgba(255,75,110,0.2);}
.btn-group{display:flex;gap:10px;margin-top:20px;}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--border);}
th{padding:12px 16px;text-align:left;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);font-family:'Space Mono',monospace;font-weight:400;}
td{padding:14px 16px;font-size:14px;border-bottom:1px solid rgba(255,255,255,0.04);}
tr:hover td{background:rgba(255,255,255,0.02);}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:8px;}
.dot-green{background:var(--green);box-shadow:0 0 6px var(--green);}
.dot-amber{background:var(--amber);box-shadow:0 0 6px var(--amber);}
.dot-red{background:var(--danger);box-shadow:0 0 6px var(--danger);}

/* SCHEDULE */
.schedule-grid{display:grid;grid-template-columns:80px repeat(5,1fr);gap:2px;font-size:12px;}
.sch-header{background:rgba(255,255,255,0.04);padding:10px;text-align:center;border-radius:6px;font-family:'Space Mono',monospace;font-weight:700;color:var(--muted);font-size:10px;letter-spacing:1px;}
.sch-time{background:rgba(255,255,255,0.03);padding:10px 8px;border-radius:6px;text-align:center;font-family:'Space Mono',monospace;color:var(--dim);font-size:10px;}
.sch-cell{border-radius:8px;padding:10px;min-height:60px;display:flex;flex-direction:column;justify-content:center;gap:2px;}
.sch-empty{background:rgba(255,255,255,0.02);}
.sch-course{cursor:pointer;transition:all 0.3s;}
.sch-course:hover{filter:brightness(1.2);}
.sch-course-name{font-weight:700;font-size:11px;}
.sch-course-room{font-size:10px;opacity:0.7;}
.course-1{background:rgba(0,212,255,0.12);border:1px solid rgba(0,212,255,0.2);}
.course-2{background:rgba(123,97,255,0.12);border:1px solid rgba(123,97,255,0.2);}
.course-3{background:rgba(0,255,170,0.08);border:1px solid rgba(0,255,170,0.18);}
.course-4{background:rgba(255,181,71,0.08);border:1px solid rgba(255,181,71,0.18);}
.course-5{background:rgba(255,75,110,0.08);border:1px solid rgba(255,75,110,0.18);}

/* ABSENCE TABLE */
.absence-stat{
  display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;
}
.absence-box{
  background:var(--panel);border:1px solid var(--border2);border-radius:16px;
  padding:18px 20px;text-align:center;
}
.absence-num{font-family:'Space Mono',monospace;font-weight:700;font-size:32px;margin-bottom:4px;}
.absence-num.safe{color:var(--green);}
.absence-num.warn{color:var(--amber);}
.absence-num.crit{color:var(--danger);}

/* ADMIN USER TABLE */
.user-row{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:14px;transition:all 0.2s;cursor:pointer;border:1px solid transparent;}
.user-row:hover{background:rgba(255,255,255,0.04);border-color:var(--border2);}
.user-mini-avatar{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--glow2),var(--glow));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden;}
.user-mini-avatar img{width:100%;height:100%;object-fit:cover;}
.user-row-info{flex:1;}
.user-row-name{font-weight:700;font-size:14px;}
.user-row-meta{font-size:12px;color:var(--muted);}
.user-row-actions{display:flex;gap:8px;opacity:0;}
.user-row:hover .user-row-actions{opacity:1;}
.action-btn{padding:6px 12px;border-radius:8px;font-size:12px;font-family:'Outfit',sans-serif;font-weight:700;cursor:pointer;border:1px solid var(--border2);background:rgba(255,255,255,0.05);color:var(--muted);transition:all 0.2s;}
.action-btn:hover{color:var(--text);background:rgba(255,255,255,0.1);}
.action-btn.edit:hover{color:var(--glow);border-color:rgba(0,212,255,0.3);}
.action-btn.del:hover{color:var(--danger);border-color:rgba(255,75,110,0.3);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{
  background:linear-gradient(135deg,#0d1425,#080d18);
  border:1px solid var(--border);border-radius:24px;
  width:100%;max-width:600px;max-height:90vh;overflow-y:auto;
  box-shadow:0 30px 80px rgba(0,0,0,0.6);
  animation:modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
.modal-header{
  padding:24px 28px 20px;border-bottom:1px solid var(--border2);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-title{font-weight:800;font-size:18px;}
.modal-close{
  width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.06);
  border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;color:var(--muted);transition:all 0.2s;
}
.modal-close:hover{background:rgba(255,75,110,0.15);color:var(--danger);border-color:rgba(255,75,110,0.3);}
.modal-body{padding:28px;}

/* TOAST */
.toast{
  position:fixed;bottom:30px;right:30px;z-index:9999;
  background:linear-gradient(135deg,rgba(13,20,37,0.95),rgba(8,13,24,0.98));
  border:1px solid var(--border);border-radius:14px;
  padding:14px 20px;display:flex;align-items:center;gap:12px;
  font-size:14px;font-weight:600;min-width:280px;
  box-shadow:0 10px 40px rgba(0,0,0,0.4);
  transform:translateY(100px);opacity:0;transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.toast.show{transform:translateY(0);opacity:1;}
.toast-icon{font-size:20px;}

/* GUEST BANNER */
.guest-banner{
  background:linear-gradient(135deg,rgba(255,181,71,0.08),rgba(255,75,110,0.06));
  border:1px solid rgba(255,181,71,0.2);border-radius:14px;
  padding:14px 20px;margin-bottom:24px;
  display:flex;align-items:center;gap:12px;font-size:13px;color:var(--amber);
}

/* PROGRESS BARS */
.progress-wrap{margin-bottom:14px;}
.progress-info{display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;}
.progress-bar{height:6px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;}
.progress-fill{height:100%;border-radius:10px;transition:width 1s ease;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(0,212,255,0.2);border-radius:10px;}

/* RESPONSIVE hint */
@media(max-width:900px){.grid-4{grid-template-columns:repeat(2,1fr);}.form-grid-3{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<!-- ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üéì</div>
    <span class="logo-text">NEXUS</span>
  </div>

  <div class="nav-section">
    <div class="nav-label">G√©n√©ral</div>
    <a class="nav-item active" data-page="profile" onclick="navTo('profile',this)">
      <span class="icon">üë§</span> Mon Profil
    </a>
    <a class="nav-item" data-page="dashboard" onclick="navTo('dashboard',this)">
      <span class="icon">üìä</span> Tableau de bord
    </a>
  </div>

  <div class="nav-section">
    <div class="nav-label">Scolarit√©</div>
    <a class="nav-item" data-page="schedule" onclick="navTo('schedule',this)">
      <span class="icon">üìÖ</span> Emploi du temps
    </a>
    <a class="nav-item" data-page="courses" onclick="navTo('courses',this)">
      <span class="icon">üìö</span> Mes Cours
    </a>
    <a class="nav-item" data-page="grades" onclick="navTo('grades',this)">
      <span class="icon">üèÜ</span> Notes & R√©sultats
    </a>
    <a class="nav-item" data-page="absences" onclick="navTo('absences',this)">
      <span class="icon">üìã</span> Absences <span class="nav-badge" id="absenceBadge" style="display:none">3</span>
    </a>
  </div>

  <div class="nav-section">
    <div class="nav-label">Services</div>
    <a class="nav-item" data-page="documents" onclick="navTo('documents',this)">
      <span class="icon">üìÑ</span> Documents
    </a>
    <a class="nav-item" data-page="announcements" onclick="navTo('announcements',this)">
      <span class="icon">üì¢</span> Annonces <span class="nav-badge" id="annBadge" style="display:none">0</span>
    </a>
    <a class="nav-item" data-page="contact" onclick="navTo('contact',this)">
      <span class="icon">‚úâÔ∏è</span> Contact
    </a>
  </div>

  <!-- ADMIN section -->
  <div class="nav-section" id="adminNav" style="display:none">
    <div class="nav-label">Administration</div>
    <a class="nav-item" data-page="admin-users" onclick="navTo('admin-users',this)">
      <span class="icon">üë•</span> G√©rer √âtudiants
    </a>
    <a class="nav-item" data-page="admin-create" onclick="navTo('admin-create',this)">
      <span class="icon">‚ûï</span> Cr√©er un compte
    </a>
  </div>

  <div class="admin-toggle-wrap">
    <div class="view-toggle" id="viewToggle" style="display:none">
      <button class="toggle-btn active" id="adminViewBtn" onclick="setViewMode('admin')">‚öô Admin</button>
      <button class="toggle-btn" id="guestViewBtn" onclick="setViewMode('guest')">üëÅ Visiteur</button>
    </div>
    <div class="sidebar-profile">
      <div class="s-avatar"><img id="sidebarPhoto" src="" onerror="this.style.display='none';this.parentElement.textContent='üë§'"><span style="display:none">üë§</span></div>
      <div class="s-info">
        <div class="s-name" id="sidebarName">Chargement...</div>
        <div class="s-role" id="sidebarRole">√âtudiant</div>
      </div>
    </div>
    <form action="/api/logout" method="POST">
      <button type="submit" class="logout-btn">‚Ü≥ D√©connexion</button>
    </form>
  </div>
</aside>

<!-- ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ -->
<main class="main">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <div class="page-title" id="pageTitle">PROFIL</div>
      <div class="page-name" id="pageName">Mon Profil</div>
    </div>
    <div class="header-right">
      <div class="notif-btn" onclick="navTo('announcements', document.querySelector('[data-page=announcements]'));clearNotifCount()">
        üîî<span class="notif-dot" id="notifDot" style="display:none"></span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: PROFILE ‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-profile">
    <div id="guestBanner" class="guest-banner" style="display:none">
      üëÅ &nbsp;Mode visiteur ‚Äî Vous voyez le portail comme un √©tudiant. <button onclick="setViewMode('admin')" style="margin-left:auto;background:rgba(255,181,71,0.15);border:1px solid rgba(255,181,71,0.3);color:var(--amber);padding:6px 14px;border-radius:8px;cursor:pointer;font-family:Outfit,sans-serif;font-weight:700;font-size:12px;">Revenir admin</button>
    </div>

    <div class="profile-hero">
      <div class="hero-avatar"><img id="heroPhoto" src="" onerror="this.style.display='none';this.parentElement.textContent='üë§'"></div>
      <div class="hero-info">
        <div class="hero-name" id="heroName">Chargement...</div>
        <div class="hero-email" id="heroEmail"></div>
        <div class="hero-tags">
          <span class="tag tag-purple" id="heroRole">√âtudiant</span>
          <span class="tag tag-blue" id="heroClass">L1 Informatique</span>
          <span class="tag tag-green" id="heroGroup">Groupe A</span>
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:24px">
      <!-- Student edit their own info -->
      <div class="card" id="studentEditCard">
        <div class="card-header">
          <div class="card-title">‚úèÔ∏è Modifier mes informations</div>
        </div>
        <div class="card-body">
          <form action="/api/update" method="POST" enctype="multipart/form-data">
            <div class="photo-upload-wrap">
              <div class="photo-preview" onclick="document.getElementById('photoInput').click()">
                <img id="photoPreview" src="" style="display:none">
                <span id="photoPlaceholder">üì∏</span>
              </div>
              <div class="photo-info">
                <strong style="font-size:13px">Photo de profil</strong>
                <p>JPG, PNG ¬∑ max 5 Mo</p>
                <label class="upload-btn" onclick="document.getElementById('photoInput').click()">Choisir une photo</label>
              </div>
            </div>
            <input type="file" id="photoInput" name="photo" accept="image/*" onchange="previewPhoto(this)">
            <div class="form-section">
              <div class="form-section-title">Identit√©</div>
              <div class="form-grid">
                <div class="field"><label>Pr√©nom</label><input type="text" name="firstname" id="inputFirstname" placeholder="Votre pr√©nom"></div>
                <div class="field"><label>Nom</label><input type="text" name="lastname" id="inputLastname" placeholder="Votre nom"></div>
                <div class="field"><label>T√©l√©phone</label><input type="tel" name="phone" id="inputPhone" placeholder="+213 6..."></div>
                <div class="field"><label>Date de naissance</label><input type="date" name="birthdate" id="inputBirth"></div>
                <div class="field"><label>Ville</label><input type="text" name="city" id="inputCity" placeholder="Alger, Paris..."></div>
                <div class="field"><label>Nationalit√©</label><input type="text" name="nationality" id="inputNationality" placeholder="Alg√©rienne..."></div>
              </div>
            </div>
            <div class="form-section">
              <div class="form-section-title">R√©seaux & Contact</div>
              <div class="form-grid">
                <div class="field"><label>LinkedIn</label><input type="url" name="linkedin" id="inputLinkedin" placeholder="linkedin.com/in/..."></div>
                <div class="field"><label>GitHub</label><input type="url" name="github" id="inputGithub" placeholder="github.com/..."></div>
                <div class="field full"><label>Bio courte</label><textarea name="bio" id="inputBio" placeholder="D√©crivez-vous en quelques mots..."></textarea></div>
              </div>
            </div>
            <div class="field" style="margin-bottom:16px">
              <label>Langue pr√©f√©r√©e</label>
              <select name="language" id="inputLanguage">
                <option value="fr">üá´üá∑ Fran√ßais</option>
                <option value="ar">üá©üáø Arabe</option>
                <option value="en">üá¨üáß Anglais</option>
              </select>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Enregistrer les modifications ‚úì</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Info display card -->
      <div>
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">üìã Informations scolaires</div></div>
          <div class="card-body">
            <div style="display:grid;gap:14px">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border2)">
                <span style="color:var(--muted);font-size:13px">Formation</span>
                <span class="tag tag-purple" id="infoClass">L1 Informatique</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border2)">
                <span style="color:var(--muted);font-size:13px">Groupe TD</span>
                <span class="tag tag-blue" id="infoGroup">Groupe A</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border2)">
                <span style="color:var(--muted);font-size:13px">Ann√©e universitaire</span>
                <span style="font-weight:700">2025 ‚Äî 2026</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0">
                <span style="color:var(--muted);font-size:13px">Statut</span>
                <span><span class="status-dot dot-green"></span>Inscrit</span>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìà Progression</div></div>
          <div class="card-body">
            <div class="progress-wrap">
              <div class="progress-info"><span>Algorithmique</span><span style="color:var(--green)">87%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:87%;background:linear-gradient(90deg,var(--glow2),var(--glow))"></div></div>
            </div>
            <div class="progress-wrap">
              <div class="progress-info"><span>Math√©matiques</span><span style="color:var(--amber)">64%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:64%;background:linear-gradient(90deg,var(--amber),#ff8a00)"></div></div>
            </div>
            <div class="progress-wrap">
              <div class="progress-info"><span>Syst√®mes</span><span style="color:var(--glow)">75%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:75%;background:linear-gradient(90deg,var(--glow),var(--green))"></div></div>
            </div>
            <div class="progress-wrap">
              <div class="progress-info"><span>R√©seaux</span><span style="color:var(--danger)">52%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:52%;background:linear-gradient(90deg,var(--danger),#ff8a6e)"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: DASHBOARD ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-dashboard">
    <div class="grid-4" style="margin-bottom:24px">
      <div class="stat-card blue"><div class="stat-icon">üéØ</div><div class="stat-val">14.2</div><div class="stat-label">Moyenne g√©n√©rale</div></div>
      <div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-val">87%</div><div class="stat-label">Pr√©sences</div></div>
      <div class="stat-card amber"><div class="stat-icon">üìö</div><div class="stat-val">6</div><div class="stat-label">Modules en cours</div></div>
      <div class="stat-card red"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-val">3</div><div class="stat-label">Absences justif.</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">üìÜ Prochains cours</div></div>
        <div class="card-body">
          <div style="display:grid;gap:10px">
            <div style="display:flex;align-items:center;gap:14px;padding:12px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.15);border-radius:12px">
              <div style="text-align:center;min-width:48px"><div style="font-family:'Space Mono';font-weight:700;font-size:16px;color:var(--glow)">08h</div><div style="font-size:10px;color:var(--muted)">LUN</div></div>
              <div><div style="font-weight:700">Algorithmique Avanc√©e</div><div style="font-size:12px;color:var(--muted)">Salle B204 ¬∑ M. Benali</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:14px;padding:12px;background:rgba(123,97,255,0.06);border:1px solid rgba(123,97,255,0.15);border-radius:12px">
              <div style="text-align:center;min-width:48px"><div style="font-family:'Space Mono';font-weight:700;font-size:16px;color:#a78bff">10h</div><div style="font-size:10px;color:var(--muted)">LUN</div></div>
              <div><div style="font-weight:700">Bases de donn√©es</div><div style="font-size:12px;color:var(--muted)">Salle A101 ¬∑ Mme Ziani</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:14px;padding:12px;background:rgba(0,255,170,0.04);border:1px solid rgba(0,255,170,0.12);border-radius:12px">
              <div style="text-align:center;min-width:48px"><div style="font-family:'Space Mono';font-weight:700;font-size:16px;color:var(--green)">14h</div><div style="font-size:10px;color:var(--muted)">MAR</div></div>
              <div><div style="font-weight:700">Math√©matiques Disc.</div><div style="font-size:12px;color:var(--muted)">Amphi 3 ¬∑ M. Karim</div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üì¢ Derni√®res annonces</div></div>
        <div class="card-body">
          <div style="display:grid;gap:10px">
            <div style="padding:14px;background:rgba(255,181,71,0.06);border:1px solid rgba(255,181,71,0.15);border-radius:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:10px;background:rgba(255,181,71,0.15);color:var(--amber);padding:3px 8px;border-radius:20px;font-weight:700;letter-spacing:1px">INFO</span></div>
              <div style="font-weight:700;font-size:14px;margin-bottom:4px">Bienvenue ‚Äî Ann√©e 2025/2026</div>
              <div style="font-size:12px;color:var(--muted)">L'ann√©e universitaire 2025/2026 a d√©but√©. Consultez r√©guli√®rement les annonces.</div>
            </div>
            <div style="padding:14px;background:rgba(0,212,255,0.04);border:1px solid var(--border2);border-radius:12px">
              <div style="font-weight:700;font-size:14px;margin-bottom:4px">Aucune annonce urgente</div>
              <div style="font-size:12px;color:var(--muted)">Aucune annonce pour le moment.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: SCHEDULE ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-schedule">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìÖ Emploi du temps ‚Äî Semaine S4</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" style="padding:8px 14px;font-size:12px">‚Üê Pr√©c.</button>
          <button class="btn btn-secondary" style="padding:8px 14px;font-size:12px">Suiv. ‚Üí</button>
        </div>
      </div>
      <div class="card-body">
        <div class="schedule-grid">
          <div class="sch-header"></div>
          <div class="sch-header">LUNDI</div><div class="sch-header">MARDI</div>
          <div class="sch-header">MERCREDI</div><div class="sch-header">JEUDI</div><div class="sch-header">VENDREDI</div>
          <!-- 08h -->
          <div class="sch-time">08:00</div>
          <div class="sch-cell sch-course course-1"><div class="sch-course-name">Algorithmique</div><div class="sch-course-room">B204</div></div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-3"><div class="sch-course-name">Anglais</div><div class="sch-course-room">C101</div></div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-5"><div class="sch-course-name">R√©seaux</div><div class="sch-course-room">Lab R</div></div>
          <!-- 10h -->
          <div class="sch-time">10:00</div>
          <div class="sch-cell sch-course course-2"><div class="sch-course-name">Bases de donn√©es</div><div class="sch-course-room">A101</div></div>
          <div class="sch-cell sch-course course-1"><div class="sch-course-name">Algorithmique TD</div><div class="sch-course-room">B205</div></div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-2"><div class="sch-course-name">BDD TP</div><div class="sch-course-room">Lab Info</div></div>
          <div class="sch-cell sch-empty"></div>
          <!-- 14h -->
          <div class="sch-time">14:00</div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-4"><div class="sch-course-name">Math√©matiques</div><div class="sch-course-room">Amphi 3</div></div>
          <div class="sch-cell sch-course course-2"><div class="sch-course-name">Syst√®mes</div><div class="sch-course-room">A204</div></div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-3"><div class="sch-course-name">Anglais TD</div><div class="sch-course-room">C102</div></div>
          <!-- 16h -->
          <div class="sch-time">16:00</div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-empty"></div>
          <div class="sch-cell sch-course course-5"><div class="sch-course-name">R√©seaux TD</div><div class="sch-course-room">Lab R</div></div>
          <div class="sch-cell sch-course course-4"><div class="sch-course-name">Maths TD</div><div class="sch-course-room">B101</div></div>
          <div class="sch-cell sch-empty"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: COURSES ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-courses">
    <div class="grid-3">
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,var(--glow2),var(--glow));border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">‚ö°</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">Algorithmique Avanc√©e</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">M. Benali ¬∑ 3 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:87%;background:linear-gradient(90deg,var(--glow2),var(--glow))"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 87%</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,#a78bff,var(--glow2));border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">üóÑÔ∏è</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">Bases de Donn√©es</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Mme Ziani ¬∑ 4 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:73%;background:linear-gradient(90deg,#a78bff,var(--glow2))"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 73%</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,var(--amber),#ff8a00);border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">‚àë</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">Math√©matiques Disc.</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">M. Karim ¬∑ 3 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:64%;background:linear-gradient(90deg,var(--amber),#ff8a00)"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 64%</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,var(--green),#00d4aa);border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">üåê</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">Anglais Technique</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Mme Ferrahi ¬∑ 2 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:90%;background:linear-gradient(90deg,var(--green),#00d4aa)"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 90%</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,var(--danger),#ff8a6e);border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">üì°</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">R√©seaux Informatiques</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">M. Hamidi ¬∑ 4 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:52%;background:linear-gradient(90deg,var(--danger),#ff8a6e)"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 52%</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="height:6px;background:linear-gradient(90deg,var(--glow),var(--green));border-radius:0"></div>
        <div class="card-body">
          <div style="font-size:32px;margin-bottom:12px">üñ•Ô∏è</div>
          <div style="font-weight:800;font-size:16px;margin-bottom:4px">Syst√®mes d'Exploitation</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px">M. Benyahia ¬∑ 3 cr√©dits</div>
          <div class="progress-bar"><div class="progress-fill" style="width:75%;background:linear-gradient(90deg,var(--glow),var(--green))"></div></div>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">Progression: 75%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: GRADES ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-grades">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üèÜ Relev√© de notes ‚Äî S1 2025/2026</div>
        <button id="addGradeBtn" class="btn btn-primary admin-only-btn" style="padding:10px 18px;font-size:13px;display:none" onclick="openAddGradeModal()">+ Ajouter une note</button>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Module</th><th>TD</th><th>TP</th><th>Examen</th><th>Moyenne</th><th>Statut</th><th id="gradeActionsHeader" style="display:none">Actions</th></tr></thead>
            <tbody id="gradesBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:flex-end;padding-top:20px;border-top:1px solid var(--border2);margin-top:10px;gap:40px">
          <div style="text-align:right"><div style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Moyenne g√©n√©rale</div><div style="font-family:'Space Mono';font-weight:700;font-size:28px;color:var(--glow)" id="avgDisplay">‚Äî</div></div>
          <div style="text-align:right"><div style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Cr√©dits obtenus</div><div style="font-family:'Space Mono';font-weight:700;font-size:28px;color:var(--green)" id="creditsDisplay">‚Äî</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="page" id="page-absences">
    <div class="absence-stat">
      <div class="absence-box"><div class="absence-num safe" id="absJustCount">0</div><div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Justifi√©es</div></div>
      <div class="absence-box"><div class="absence-num warn" id="absUnjustCount">0</div><div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Non justif.</div></div>
      <div class="absence-box"><div class="absence-num crit" id="absTotalCount">0</div><div style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Total</div></div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìã Historique des absences</div>
        <button id="addAbsenceBtn" class="btn btn-primary admin-only-btn" style="padding:10px 18px;font-size:13px;display:none" onclick="openAddAbsenceModal()">+ Ajouter une absence</button>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Module</th><th>Cr√©neau</th><th>Motif</th><th>Statut</th><th id="absActionsHeader" style="display:none">Actions</th></tr></thead>
            <tbody id="absencesBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: DOCUMENTS ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-documents">
    <div class="grid-3">
      <div class="card" style="cursor:pointer" onclick="showToast('üìÑ T√©l√©chargement en cours...')">
        <div class="card-body" style="display:flex;align-items:center;gap:16px">
          <div style="width:50px;height:50px;background:rgba(0,212,255,0.1);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìú</div>
          <div><div style="font-weight:700;margin-bottom:4px">Attestation de scolarit√©</div><div style="font-size:12px;color:var(--muted)">PDF ¬∑ 2025/2026</div></div>
        </div>
      </div>
      <div class="card" style="cursor:pointer" onclick="showToast('üìÑ T√©l√©chargement en cours...')">
        <div class="card-body" style="display:flex;align-items:center;gap:16px">
          <div style="width:50px;height:50px;background:rgba(123,97,255,0.1);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìä</div>
          <div><div style="font-weight:700;margin-bottom:4px">Relev√© de notes S1</div><div style="font-size:12px;color:var(--muted)">PDF ¬∑ Semestre 1</div></div>
        </div>
      </div>
      <div class="card" style="cursor:pointer" onclick="showToast('üìÑ T√©l√©chargement en cours...')">
        <div class="card-body" style="display:flex;align-items:center;gap:16px">
          <div style="width:50px;height:50px;background:rgba(0,255,170,0.08);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üéì</div>
          <div><div style="font-weight:700;margin-bottom:4px">Carte √©tudiant</div><div style="font-size:12px;color:var(--muted)">PDF ¬∑ 2025/2026</div></div>
        </div>
      </div>
      <div class="card" style="cursor:pointer" onclick="showToast('üìÑ T√©l√©chargement en cours...')">
        <div class="card-body" style="display:flex;align-items:center;gap:16px">
          <div style="width:50px;height:50px;background:rgba(255,181,71,0.08);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìÖ</div>
          <div><div style="font-weight:700;margin-bottom:4px">Emploi du temps PDF</div><div style="font-size:12px;color:var(--muted)">PDF ¬∑ Semaine actuelle</div></div>
        </div>
      </div>
      <div class="card" style="cursor:pointer" onclick="showToast('üìÑ T√©l√©chargement en cours...')">
        <div class="card-body" style="display:flex;align-items:center;gap:16px">
          <div style="width:50px;height:50px;background:rgba(255,75,110,0.08);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìã</div>
          <div><div style="font-weight:700;margin-bottom:4px">R√®glement int√©rieur</div><div style="font-size:12px;color:var(--muted)">PDF ¬∑ 2024</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: ANNOUNCEMENTS ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-announcements">
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
      <button id="addAnnouncementBtn" class="btn btn-primary admin-only-btn" style="padding:10px 18px;font-size:13px;display:none" onclick="openAddAnnouncementModal()">+ Nouvelle annonce</button>
    </div>
    <div id="announcementsList" style="display:grid;gap:16px">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: CONTACT ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-contact">
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">‚úâÔ∏è Envoyer un message</div></div>
        <div class="card-body">
          <div class="field" style="margin-bottom:14px"><label>Destinataire</label><select><option>Scolarit√© / Administration</option><option>Responsable de formation</option><option>Service financier</option><option>Biblioth√®que</option></select></div>
          <div class="field" style="margin-bottom:14px"><label>Objet</label><input type="text" placeholder="Objet de votre message..."></div>
          <div class="field" style="margin-bottom:20px"><label>Message</label><textarea style="min-height:140px" placeholder="R√©digez votre message ici..."></textarea></div>
          <button class="btn btn-primary" onclick="showToast('‚úâÔ∏è Message envoy√© avec succ√®s !')">Envoyer le message ‚Üí</button>
        </div>
      </div>
      <div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-body">
            <div style="font-weight:700;font-size:15px;margin-bottom:14px">üìç Contacts utiles</div>
            <div style="display:grid;gap:12px">
              <div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px"><div style="font-size:20px">üèõÔ∏è</div><div><div style="font-weight:600;font-size:13px">Scolarit√©</div><div style="font-size:12px;color:var(--muted)"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="eb988884878a99829f8eab9e85829d8e9998829f8ec58f91">[email&#160;protected]</a></div></div></div>
              <div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px"><div style="font-size:20px">üìö</div><div><div style="font-weight:600;font-size:13px">Biblioth√®que</div><div style="font-size:12px;color:var(--muted)"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2d4f444f4144426d5843445b485f5e445948034957">[email&#160;protected]</a></div></div></div>
              <div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px"><div style="font-size:20px">üí≥</div><div><div style="font-weight:600;font-size:13px">Service financier</div><div style="font-size:12px;color:var(--muted)"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3d5b54535c535e587d4853544b584f4e544958135947">[email&#160;protected]</a></div></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: ADMIN ‚Äî G√âRER √âTUDIANTS ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-admin-users">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üë• Liste des √©tudiants</div>
        <button class="btn btn-primary" style="padding:10px 18px;font-size:13px" onclick="navTo('admin-create', document.querySelector('[data-page=admin-create]'))">+ Cr√©er un compte</button>
      </div>
      <div class="card-body">
        <div style="margin-bottom:16px">
          <input id="userSearchInput" type="text" placeholder="üîç  Rechercher un √©tudiant..." style="width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);border-radius:12px;padding:12px 16px;color:var(--text);font-family:Outfit,sans-serif;font-size:14px;outline:none;">
        </div>
        <div id="userList" style="display:grid;gap:4px">
          <!-- Populated by JS demo data -->
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGE: ADMIN ‚Äî CR√âER COMPTE ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-admin-create">
    <div class="card" style="max-width:700px">
      <div class="card-header"><div class="card-title">‚ûï Cr√©er un compte √©tudiant</div></div>
      <div class="card-body">
        <form id="createForm" action="/api/register" method="POST">
          <div class="form-section">
            <div class="form-section-title">Connexion</div>
            <div class="form-grid">
              <div class="field"><label>Email *</label><input type="email" name="email" required placeholder="etudiant@uni.dz"></div>
              <div class="field"><label>Mot de passe *</label><input type="password" name="password" required placeholder="Min. 6 caract√®res"></div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Identit√©</div>
            <div class="form-grid">
              <div class="field"><label>Pr√©nom</label><input type="text" name="firstname" placeholder="Pr√©nom"></div>
              <div class="field"><label>Nom</label><input type="text" name="lastname" placeholder="Nom de famille"></div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Scolarit√©</div>
            <div class="form-grid-3">
              <div class="field">
                <label>R√¥le</label>
                <select name="role">
                  <option value="student">√âtudiant</option>
                  <option value="admin">Administrateur</option>
                  <option value="teacher">Enseignant</option>
                </select>
              </div>
              <div class="field">
                <label>Formation / Classe</label>
                <select name="class">
                  <option>L1 Informatique</option><option>L2 Informatique</option><option>L3 Informatique</option>
                  <option>M1 G√©nie Logiciel</option><option>M2 IA</option><option>M2 R√©seaux</option>
                </select>
              </div>
              <div class="field">
                <label>Groupe</label>
                <select name="group">
                  <option>Groupe A</option><option>Groupe B</option><option>Groupe C</option><option>Groupe D</option>
                </select>
              </div>
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">Cr√©er le compte ‚úì</button>
            <button type="button" class="btn btn-secondary" onclick="navTo('admin-users', document.querySelector('[data-page=admin-users]'))">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<!-- MODAL: Edit user (admin) -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Modifier un √©tudiant</div>
      <div class="modal-close" onclick="closeModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">Identit√©</div>
        <div class="form-grid">
          <div class="field"><label>Pr√©nom</label><input type="text" id="editFirstname" placeholder="Pr√©nom"></div>
          <div class="field"><label>Nom</label><input type="text" id="editLastname" placeholder="Nom"></div>
          <div class="field"><label>Email</label><input type="email" id="editEmail" placeholder="email@uni.dz"></div>
          <div class="field"><label>T√©l√©phone</label><input type="tel" id="editPhone" placeholder="+213 6..."></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Scolarit√©</div>
        <div class="form-grid-3">
          <div class="field">
            <label>R√¥le</label>
            <select id="editRole">
              <option value="student">√âtudiant</option>
              <option value="admin">Administrateur</option>
              <option value="teacher">Enseignant</option>
            </select>
          </div>
          <div class="field">
            <label>Classe</label>
            <select id="editClass">
              <option>L1 Informatique</option><option>L2 Informatique</option><option>L3 Informatique</option>
              <option>M1 G√©nie Logiciel</option><option>M2 IA</option>
            </select>
          </div>
          <div class="field">
            <label>Groupe</label>
            <select id="editGroup">
              <option>Groupe A</option><option>Groupe B</option><option>Groupe C</option><option>Groupe D</option>
            </select>
          </div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveEdit()">Enregistrer ‚úì</button>
        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit Grade (admin) -->
<div class="modal-overlay" id="gradeModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="gradeModalTitle">‚ûï Ajouter une note</div>
      <div class="modal-close" onclick="closeGradeModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field full"><label>Module</label><input type="text" id="gradeModule" placeholder="ex: Algorithmique"></div>
        <div class="field"><label>TD (/20)</label><input type="number" id="gradeTd" min="0" max="20" step="0.5" placeholder="‚Äî"></div>
        <div class="field"><label>TP (/20)</label><input type="number" id="gradeTp" min="0" max="20" step="0.5" placeholder="‚Äî"></div>
        <div class="field"><label>Examen (/20)</label><input type="number" id="gradeExam" min="0" max="20" step="0.5" placeholder="‚Äî"></div>
        <div class="field"><label>Cr√©dits</label><input type="number" id="gradeCredits" min="1" max="6" value="3"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveGrade()">Enregistrer ‚úì</button>
        <button class="btn btn-secondary" onclick="closeGradeModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add Absence (admin) -->
<div class="modal-overlay" id="absenceModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚ûï Ajouter une absence</div>
      <div class="modal-close" onclick="closeAbsenceModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field"><label>Date</label><input type="date" id="absDate"></div>
        <div class="field"><label>Module</label><input type="text" id="absModule" placeholder="ex: Algorithmique"></div>
        <div class="field"><label>Cr√©neau</label><input type="text" id="absCreneau" placeholder="ex: 08h ‚Äî 10h"></div>
        <div class="field"><label>Motif</label><input type="text" id="absMotif" placeholder="ex: Maladie"></div>
        <div class="field full"><label>Statut</label>
          <select id="absStatut">
            <option value="justified">Justifi√©e</option>
            <option value="unjustified">Non justifi√©e</option>
          </select>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveAbsence()">Enregistrer ‚úì</button>
        <button class="btn btn-secondary" onclick="closeAbsenceModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add Announcement (admin) -->
<div class="modal-overlay" id="announcementModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="announcementModalTitle">‚ûï Nouvelle annonce</div>
      <div class="modal-close" onclick="closeAnnouncementModal()">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field full"><label>Titre</label><input type="text" id="annTitle" placeholder="Titre de l'annonce"></div>
        <div class="field"><label>Date</label><input type="date" id="annDate"></div>
        <div class="field"><label>Type</label>
          <select id="annType">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="field full"><label>Contenu</label><textarea id="annContent" style="min-height:100px" placeholder="Contenu de l'annonce..."></textarea></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveAnnouncement()">Publier ‚úì</button>
        <button class="btn btn-secondary" onclick="closeAnnouncementModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">‚úÖ</span>
  <span id="toastMsg">Action effectu√©e</span>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let isAdmin = false;
let viewMode = 'admin'; // 'admin' or 'guest'

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ
const pageTitles = {
  'profile':'PROFIL','dashboard':'TABLEAU DE BORD','schedule':'EMPLOI DU TEMPS',
  'courses':'MES COURS','grades':'NOTES & R√âSULTATS','absences':'ABSENCES',
  'documents':'DOCUMENTS','announcements':'ANNONCES','contact':'CONTACT',
  'admin-users':'ADMIN ‚Äî √âTUDIANTS','admin-create':'ADMIN ‚Äî CR√âER COMPTE'
};
const pageNames = {
  'profile':'Mon Profil','dashboard':'Tableau de bord','schedule':'Emploi du temps',
  'courses':'Mes Cours','grades':'Notes & R√©sultats','absences':'Absences',
  'documents':'Documents','announcements':'Annonces','contact':'Nous contacter',
  'admin-users':'G√©rer les √©tudiants','admin-create':'Cr√©er un compte'
};

function navTo(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + id);
  if(page) page.classList.add('active');
  if(el) el.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[id] || id.toUpperCase();
  document.getElementById('pageName').textContent = pageNames[id] || id;
}

// ‚îÄ‚îÄ‚îÄ LOAD PROFILE ‚îÄ‚îÄ‚îÄ
async function loadProfile() {
  try {
    const res = await fetch('/api/profile');
    if(res.status === 401) { location.href = '/login.html'; return; }
    const user = await res.json();
    currentUser = user;
    isAdmin = user.role === 'admin';

    // Update hero
    const name = [user.firstname, user.lastname].filter(Boolean).join(' ') || user.email;
    document.getElementById('heroName').textContent = name;
    document.getElementById('heroEmail').textContent = user.email;
    document.getElementById('sidebarName').textContent = name;

    if(user.photo && user.photo !== 'default.png') {
      document.getElementById('heroPhoto').src = user.photo;
      document.getElementById('sidebarPhoto').src = user.photo;
    }
    if(user.role) {
      const roleMap = {admin:'Administrateur',teacher:'Enseignant',student:'√âtudiant'};
      document.getElementById('heroRole').textContent = roleMap[user.role] || '√âtudiant';
      document.getElementById('sidebarRole').textContent = roleMap[user.role] || '√âtudiant';
    }
    if(user.class) document.getElementById('heroClass').textContent = user.class;
    if(user.group) document.getElementById('heroGroup').textContent = user.group;
    if(user.class) document.getElementById('infoClass').textContent = user.class;
    if(user.group) document.getElementById('infoGroup').textContent = user.group;

    // Fill form
    if(user.firstname) document.getElementById('inputFirstname').value = user.firstname;
    if(user.lastname) document.getElementById('inputLastname').value = user.lastname;
    if(user.phone) document.getElementById('inputPhone').value = user.phone;
    if(user.language) document.getElementById('inputLanguage').value = user.language;

    // Admin features
    if(isAdmin) {
      document.getElementById('adminNav').style.display = 'block';
      document.getElementById('viewToggle').style.display = 'flex';
      loadUserList();
    }

  } catch(e) {
    console.error(e);
  }
}

// ‚îÄ‚îÄ‚îÄ ADMIN VIEW MODE ‚îÄ‚îÄ‚îÄ
function setViewMode(mode) {
  viewMode = mode;
  const adminBtn = document.getElementById('adminViewBtn');
  const guestBtn = document.getElementById('guestViewBtn');
  const adminNav = document.getElementById('adminNav');
  const guestBanner = document.getElementById('guestBanner');

  if(mode === 'admin') {
    adminBtn.classList.add('active'); guestBtn.classList.remove('active');
    adminNav.style.display = 'block';
    guestBanner.style.display = 'none';
  } else {
    guestBtn.classList.add('active'); adminBtn.classList.remove('active');
    adminNav.style.display = 'none';
    guestBanner.style.display = 'flex';
    // Navigate away from admin pages if on one
    const cur = document.querySelector('.nav-item.active')?.dataset.page;
    if(cur && cur.startsWith('admin')) navTo('profile', document.querySelector('[data-page=profile]'));
    showToast('üëÅ Mode visiteur activ√© ‚Äî Vue √©tudiant');
  }
}

// ‚îÄ‚îÄ‚îÄ REAL USER LIST (from API) ‚îÄ‚îÄ‚îÄ
let realUsers = [];

async function loadUserList() {
  const list = document.getElementById('userList');
  list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:30px">Chargement...</div>';
  try {
    const res = await fetch('/api/users');
    if (!res.ok) { list.innerHTML = '<div style="color:var(--danger);padding:20px">Erreur de chargement</div>'; return; }
    realUsers = await res.json();
    renderUserList(realUsers);
  } catch(e) {
    list.innerHTML = '<div style="color:var(--danger);padding:20px">Erreur r√©seau</div>';
  }
}

function renderUserList(users) {
  const list = document.getElementById('userList');
  const roleMap = {admin:'Administrateur', teacher:'Enseignant', student:'√âtudiant'};
  const roleTag = {admin:'tag-amber', teacher:'tag-green', student:'tag-blue'};
  if (!users.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:30px">Aucun utilisateur trouv√©</div>';
    return;
  }
  list.innerHTML = users.map(u => {
    const initials = ((u.firstname||'?')[0] + (u.lastname||'?')[0]).toUpperCase();
    const fullname = [u.firstname, u.lastname].filter(Boolean).join(' ') || u.email;
    const meta = [u.email, u.class, u.group].filter(Boolean).join(' ¬∑ ');
    return `
    <div class="user-row" onclick="openEdit(${u.id})">
      <div class="user-mini-avatar">${initials}</div>
      <div class="user-row-info">
        <div class="user-row-name">${fullname}</div>
        <div class="user-row-meta">${meta}</div>
      </div>
      <span class="tag ${roleTag[u.role]||'tag-blue'} user-row-meta" style="font-size:10px">${roleMap[u.role]||'√âtudiant'}</span>
      <div class="user-row-actions">
        <button class="action-btn edit" onclick="event.stopPropagation();openEdit(${u.id})">‚úèÔ∏è Modifier</button>
        <button class="action-btn del" onclick="event.stopPropagation();deleteUser(${u.id})">üóë Supprimer</button>
      </div>
    </div>`;
  }).join('');

  // Search filter
  document.getElementById('userSearchInput').oninput = function() {
    const q = this.value.toLowerCase();
    const filtered = realUsers.filter(u =>
      (u.firstname+' '+u.lastname+' '+u.email).toLowerCase().includes(q)
    );
    renderUserList(filtered);
    // re-bind search after re-render
    document.getElementById('userSearchInput').value = q;
    document.getElementById('userSearchInput').oninput = arguments.callee;
  };
}

let editingId = null;
function openEdit(id) {
  const u = realUsers.find(x => x.id === id);
  if(!u) return;
  editingId = id;
  document.getElementById('editFirstname').value = u.firstname || '';
  document.getElementById('editLastname').value = u.lastname || '';
  document.getElementById('editEmail').value = u.email || '';
  document.getElementById('editPhone').value = u.phone || '';
  document.getElementById('editRole').value = u.role || 'student';
  document.getElementById('editClass').value = u.class || 'L1 Informatique';
  document.getElementById('editGroup').value = u.group || 'Groupe A';
  document.getElementById('editModal').classList.add('open');
}
function closeModal() { document.getElementById('editModal').classList.remove('open'); }
async function saveEdit() {
  const u = realUsers.find(x => x.id === editingId);
  if(!u) return;
  const payload = {
    id: editingId,
    firstname: document.getElementById('editFirstname').value,
    lastname:  document.getElementById('editLastname').value,
    email:     document.getElementById('editEmail').value,
    phone:     document.getElementById('editPhone').value,
    role:      document.getElementById('editRole').value,
    class:     document.getElementById('editClass').value,
    group:     document.getElementById('editGroup').value,
  };
  try {
    const res = await fetch('/api/users', {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) { const e = await res.json(); showToast('‚ùå ' + e.error, '‚ùå'); return; }
    closeModal();
    showToast('‚úÖ Modifications enregistr√©es');
    loadUserList();
  } catch(e) {
    showToast('‚ùå Erreur r√©seau', '‚ùå');
  }
}
async function deleteUser(id) {
  if(!confirm('Supprimer cet utilisateur ?')) return;
  try {
    const res = await fetch('/api/users?id=' + id, { method: 'DELETE' });
    if (!res.ok) { const e = await res.json(); showToast('‚ùå ' + e.error, '‚ùå'); return; }
    showToast('üóëÔ∏è Utilisateur supprim√©');
    loadUserList();
  } catch(e) {
    showToast('‚ùå Erreur r√©seau', '‚ùå');
  }
}

// ‚îÄ‚îÄ‚îÄ PHOTO PREVIEW ‚îÄ‚îÄ‚îÄ
function previewPhoto(input) {
  if(!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    const prev = document.getElementById('photoPreview');
    prev.src = e.target.result;
    prev.style.display = 'block';
    document.getElementById('photoPlaceholder').style.display = 'none';
  };
  reader.readAsDataURL(input.files[0]);
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg, icon='‚úÖ') {
  const toast = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  document.getElementById('toastIcon').textContent = icon;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ‚îÄ GRADES DATA ‚îÄ‚îÄ‚îÄ
let gradesData = [];
let editingGradeIdx = null;

function renderGrades() {
  const tbody = document.getElementById('gradesBody');
  if (!tbody) return;
  if (gradesData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">Aucune note enregistr√©e</td></tr>';
    document.getElementById('avgDisplay').textContent = '‚Äî';
    document.getElementById('creditsDisplay').textContent = '‚Äî';
    return;
  }
  const statusColor = {Valid√©:'var(--green)', Passable:'var(--amber)', Rattrapage:'var(--danger)'};
  const dotClass = {Valid√©:'dot-green', Passable:'dot-amber', Rattrapage:'dot-red'};
  tbody.innerHTML = gradesData.map((g, i) => {
    const avg = calcAvg(g);
    const status = avg >= 12 ? 'Valid√©' : avg >= 10 ? 'Passable' : 'Rattrapage';
    const adminCols = isAdmin ? `<td><button class="action-btn edit" onclick="openEditGrade(${i})">‚úèÔ∏è</button> <button class="action-btn del" onclick="deleteGrade(${i})">üóëÔ∏è</button></td>` : '';
    return `<tr>
      <td><strong>${g.module}</strong></td>
      <td>${g.td !== '' ? g.td+'/20' : '‚Äî'}</td>
      <td>${g.tp !== '' ? g.tp+'/20' : '‚Äî'}</td>
      <td>${g.exam !== '' ? g.exam+'/20' : '‚Äî'}</td>
      <td><strong style="color:${statusColor[status]}">${avg.toFixed(1)}</strong></td>
      <td><span class="status-dot ${dotClass[status]}"></span>${status}</td>
      ${adminCols}
    </tr>`;
  }).join('');
  // Show/hide actions column header
  const header = document.getElementById('gradeActionsHeader');
  if (header) header.style.display = isAdmin ? '' : 'none';
  // Overall average
  const total = gradesData.reduce((s, g) => s + calcAvg(g), 0);
  const avg = (total / gradesData.length).toFixed(1);
  const totalCredits = gradesData.reduce((s, g) => s + (parseInt(g.credits)||3), 0);
  const earnedCredits = gradesData.filter(g => calcAvg(g) >= 10).reduce((s, g) => s + (parseInt(g.credits)||3), 0);
  document.getElementById('avgDisplay').textContent = avg;
  document.getElementById('creditsDisplay').textContent = `${earnedCredits}/${totalCredits}`;
}

function calcAvg(g) {
  const vals = [g.td, g.tp, g.exam].filter(v => v !== '' && v !== null && v !== undefined);
  if (!vals.length) return 0;
  return vals.reduce((s, v) => s + parseFloat(v), 0) / vals.length;
}

function openAddGradeModal() {
  editingGradeIdx = null;
  document.getElementById('gradeModalTitle').textContent = '‚ûï Ajouter une note';
  document.getElementById('gradeModule').value = '';
  document.getElementById('gradeTd').value = '';
  document.getElementById('gradeTp').value = '';
  document.getElementById('gradeExam').value = '';
  document.getElementById('gradeCredits').value = '3';
  document.getElementById('gradeModal').classList.add('open');
}

function openEditGrade(idx) {
  editingGradeIdx = idx;
  const g = gradesData[idx];
  document.getElementById('gradeModalTitle').textContent = '‚úèÔ∏è Modifier une note';
  document.getElementById('gradeModule').value = g.module;
  document.getElementById('gradeTd').value = g.td;
  document.getElementById('gradeTp').value = g.tp;
  document.getElementById('gradeExam').value = g.exam;
  document.getElementById('gradeCredits').value = g.credits || 3;
  document.getElementById('gradeModal').classList.add('open');
}

function closeGradeModal() { document.getElementById('gradeModal').classList.remove('open'); }

function saveGrade() {
  const entry = {
    module: document.getElementById('gradeModule').value.trim(),
    td: document.getElementById('gradeTd').value,
    tp: document.getElementById('gradeTp').value,
    exam: document.getElementById('gradeExam').value,
    credits: document.getElementById('gradeCredits').value
  };
  if (!entry.module) { showToast('‚ö†Ô∏è Veuillez saisir un module', '‚ö†Ô∏è'); return; }
  if (editingGradeIdx !== null) {
    gradesData[editingGradeIdx] = entry;
    showToast('‚úÖ Note modifi√©e');
  } else {
    gradesData.push(entry);
    showToast('‚úÖ Note ajout√©e');
  }
  closeGradeModal();
  renderGrades();
}

function deleteGrade(idx) {
  if (confirm('Supprimer cette note ?')) {
    gradesData.splice(idx, 1);
    renderGrades();
    showToast('üóëÔ∏è Note supprim√©e');
  }
}

// ‚îÄ‚îÄ‚îÄ ABSENCES DATA ‚îÄ‚îÄ‚îÄ
let absencesData = [];

function renderAbsences() {
  const tbody = document.getElementById('absencesBody');
  if (!tbody) return;
  let just = 0, unjust = 0;
  if (absencesData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">Aucune absence enregistr√©e</td></tr>';
  } else {
    tbody.innerHTML = absencesData.map((a, i) => {
      const isJust = a.statut === 'justified';
      if (isJust) just++; else unjust++;
      const badge = isJust
        ? `<span class="tag tag-green" style="font-size:10px;padding:3px 10px">Justifi√©e</span>`
        : `<span class="tag" style="background:rgba(255,75,110,0.1);color:#ff7a95;border:1px solid rgba(255,75,110,0.25);font-size:10px;padding:3px 10px">Non justif.</span>`;
      const adminCols = isAdmin ? `<td><button class="action-btn del" onclick="deleteAbsence(${i})">üóëÔ∏è</button></td>` : '';
      return `<tr>
        <td>${a.date}</td><td>${a.module}</td><td>${a.creneau}</td>
        <td>${a.motif || '‚Äî'}</td><td>${badge}</td>${adminCols}
      </tr>`;
    }).join('');
  }
  document.getElementById('absJustCount').textContent = just;
  document.getElementById('absUnjustCount').textContent = unjust;
  document.getElementById('absTotalCount').textContent = absencesData.length;
  const header = document.getElementById('absActionsHeader');
  if (header) header.style.display = isAdmin ? '' : 'none';
}

function openAddAbsenceModal() {
  document.getElementById('absDate').value = '';
  document.getElementById('absModule').value = '';
  document.getElementById('absCreneau').value = '';
  document.getElementById('absMotif').value = '';
  document.getElementById('absStatut').value = 'justified';
  document.getElementById('absenceModal').classList.add('open');
}
function closeAbsenceModal() { document.getElementById('absenceModal').classList.remove('open'); }

function saveAbsence() {
  const entry = {
    date: document.getElementById('absDate').value,
    module: document.getElementById('absModule').value.trim(),
    creneau: document.getElementById('absCreneau').value.trim(),
    motif: document.getElementById('absMotif').value.trim(),
    statut: document.getElementById('absStatut').value
  };
  if (!entry.date || !entry.module) { showToast('‚ö†Ô∏è Date et module requis', '‚ö†Ô∏è'); return; }
  absencesData.push(entry);
  renderAbsences();
  closeAbsenceModal();
  showToast('‚úÖ Absence enregistr√©e');
}

function deleteAbsence(idx) {
  if (confirm('Supprimer cette absence ?')) {
    absencesData.splice(idx, 1);
    renderAbsences();
    showToast('üóëÔ∏è Absence supprim√©e');
  }
}

// ‚îÄ‚îÄ‚îÄ ANNOUNCEMENTS DATA ‚îÄ‚îÄ‚îÄ
let announcementsData = [];
let editingAnnIdx = null;

function renderAnnouncements() {
  const list = document.getElementById('announcementsList');
  if (!list) return;
  if (announcementsData.length === 0) {
    list.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:var(--muted);padding:40px">Aucune annonce pour le moment.</div></div>';
    return;
  }
  const months = ['JAN','F√âV','MAR','AVR','MAI','JUN','JUL','AO√õ','SEP','OCT','NOV','D√âC'];
  list.innerHTML = announcementsData.map((a, i) => {
    const d = a.date ? new Date(a.date) : null;
    const day = d ? d.getDate().toString().padStart(2,'0') : '‚Äî';
    const month = d ? months[d.getMonth()] : '';
    const urgentBadge = a.type === 'urgent'
      ? `<span class="tag" style="background:rgba(255,75,110,0.1);color:#ff7a95;border:1px solid rgba(255,75,110,0.25);font-size:10px;padding:2px 8px">URGENT</span>`
      : '';
    const dayColor = a.type === 'urgent' ? 'var(--danger)' : 'var(--glow)';
    const adminBtns = isAdmin ? `<div style="display:flex;gap:8px;margin-top:8px">
      <button class="action-btn edit" onclick="deleteAnnouncement(${i})">üóëÔ∏è Supprimer</button>
    </div>` : '';
    return `<div class="card">
      <div class="card-body" style="display:flex;gap:20px">
        <div style="min-width:56px;text-align:center">
          <div style="font-family:'Space Mono';font-weight:700;color:${dayColor};font-size:22px">${day}</div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase">${month}</div>
        </div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <span style="font-weight:800;font-size:16px">${a.title}</span>${urgentBadge}
          </div>
          <div style="color:var(--muted);font-size:13px">${a.content}</div>
          ${adminBtns}
        </div>
      </div>
    </div>`;
  }).join('');
}

function openAddAnnouncementModal() {
  editingAnnIdx = null;
  document.getElementById('announcementModalTitle').textContent = '‚ûï Nouvelle annonce';
  document.getElementById('annTitle').value = '';
  document.getElementById('annDate').value = '';
  document.getElementById('annType').value = 'normal';
  document.getElementById('annContent').value = '';
  document.getElementById('announcementModal').classList.add('open');
}
function closeAnnouncementModal() { document.getElementById('announcementModal').classList.remove('open'); }

function saveAnnouncement() {
  const entry = {
    title: document.getElementById('annTitle').value.trim(),
    date: document.getElementById('annDate').value,
    type: document.getElementById('annType').value,
    content: document.getElementById('annContent').value.trim()
  };
  if (!entry.title) { showToast('‚ö†Ô∏è Titre requis', '‚ö†Ô∏è'); return; }
  announcementsData.unshift(entry);
  renderAnnouncements();
  closeAnnouncementModal();
  showToast('‚úÖ Annonce publi√©e');
  // Increment notification counter
  notifCount++;
  updateNotifUI();
}

let notifCount = 0;
function updateNotifUI() {
  const dot = document.getElementById('notifDot');
  const badge = document.getElementById('annBadge');
  if (notifCount > 0) {
    dot.style.display = '';
    badge.style.display = '';
    badge.textContent = notifCount;
  } else {
    dot.style.display = 'none';
    badge.style.display = 'none';
  }
}
function clearNotifCount() {
  notifCount = 0;
  updateNotifUI();
}

function deleteAnnouncement(idx) {
  if (confirm('Supprimer cette annonce ?')) {
    announcementsData.splice(idx, 1);
    renderAnnouncements();
    showToast('üóëÔ∏è Annonce supprim√©e');
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ADMIN BUTTONS ‚îÄ‚îÄ‚îÄ
function initAdminContentButtons() {
  document.querySelectorAll('.admin-only-btn').forEach(btn => {
    btn.style.display = isAdmin ? '' : 'none';
  });
  renderGrades();
  renderAbsences();
  renderAnnouncements();
}

loadProfile().then(() => {
  initAdminContentButtons();
});
</script>
</body>
</html>